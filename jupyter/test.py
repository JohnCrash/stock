"""
d1是k1的日期表,将k1和日期表date对齐
d1和date来自于loadKline的返回日期
"""
import numpy as np
import stock
import status
import shared
import xueqiu
import threading
import queue
import time
from datetime import datetime,date,timedelta
from IPython.core.interactiveshell import InteractiveShell
import kline
"""
display_pub = InteractiveShell.instance().display_pub
display_pub.publish(data='hell',metadata={})
c,k,d = stock.loadKline('SH:000001')

r = stock.volumeprices(k,d)
"""
#b,k = xueqiu.sinaK5('SH000001',96)
#for i in range(len(k)):
#    print(i,k[i])
"""
period = 5
code = 'SH000001'
cacheName = "k%s_%s"%(str(period).lower(),code.lower())
b,cache = shared.fromRedis(cacheName)
print(cache['base'])
k = cache['k']
d = cache['date']
for i in range(len(k)):
    print(i,k[i],d[i])
"""
#b,k,d = xueqiu.qqK15('SZ399001')
#c,k,d = stock.loadKline('SZ399001',5)
#stock.correctionVolume(k,d,5)
#print(xueqiu.from2now(11,30,5))
#c,k,d = stock.loadKline('SZ399001',15)
#b,k,d = xueqiu.appendK('SZ399001',15,k,d)
#b,d = xueqiu.xueqiuK5('SZ399001',96)
#print(d)
#xueqiu.K('SH000001',15,16)
"""
for i in range(5):   
    if b:
        print(s,d[0],d[-1],'\n')
    else:
        print('error\n')
"""        
#print(xueqiu.K('SZ000158',5,96))
#c,k,d = stock.loadKline('SZ399001',5)
#b,k,d = xueqiu.appendK('SZ399001',5,k,d)
#code = 'SH603369'
#cacheName = "k%s_%s"%(str(15).lower(),code.lower())
#shared.delKey(cacheName)
#b,k,d = xueqiu.xueqiuKday(code,15)
#print(xueqiu.nextKDate(datetime(2020,2,25,10,55),5))
#print(xueqiu.from2now(10,55,5))
#print(xueqiu.k5date)
#print(xueqiu.k15date)
#r = status.StrongSorted([5])
#print(r)
#shared.delKey("company_status_last50")
#shared.delKey("company_status_date50")
#def progress(e):
#    pass
#status.update_status_begin(date(2020,2,21),False,progress)

#shared.delKey("k5_sz000158")
#shared.delKey("k5_sz002796")
#shared.delKey("k5_sz002837")
#shared.delKey("k5_sh603825")
#print(xueqiu.from2now(datetime(2020,2,26,15,40),5))

#def K(code):
#    kline.Plote(code,'d',config={'index':True},mode='runtime',temp=-43).showKline()
#K('SH000001')
#c,k,d = stock.loadKline('SZ399001','d')
#m = stock.macd(k)
#stock.MacdBestPt(k,m)
#def progress(i):
#    print(i)
#r = status.StrongSorted5k([3,6,12],N=96,progress=progress)
#print(len(r))

"""
ls = stock.query("select id,name from category")
for it in ls:
    r = stock.query("select id,name from company where category=%d"%(it[0]))
    if len(r)==0:
        s = "delete from category where id=%d"%(it[0])
        print(s)
        stock.execute(s)
"""
"""
companys = stock.query("select code,name from company")
coms = []
for com in companys:
    coms.append(com[0])
def progress(i):
    print(i)
status.downloadAllK(coms,5,96,progress)
"""
#xueqiu.sinaRT(coms[:100])
#print(xueqiu.nextKDate(datetime.today(),5))
#print("next:",xueqiu.next_k_timestamp(datetime(2020,3,11,9,1),5))
#print("prev:",xueqiu.prev_k_timestamp(datetime(2020,3,11,9,1),5))
#c = stock.query("select code from company")
#print(c[0])

#b,k,d = xueqiu.K2('SH603499')
#print(k[-1],len(k))
#print(d[-1],len(d))
"""
companys = stock.query("select company_id,code,name,category from company_select")
coms = []
id2com = {}
for com in companys:
    coms.append(com[1])
    id2com[com[0]] = com
def progress(i):
    print(i)
"""
#result = status.StrongSortedRT([5,15,45,90],progress,companys)
"""
D,K = status.downloadAllKFast(companys,progress)
for i in range(len(K)):
    idd = int(K[i,-1,0])
    print(idd,id2com[idd][1],id2com[idd][2],K[i,-1,2],K[i,-1,1])
"""
#s = """v_sh601872="1~招商轮船~601872~6.11~5.55~6.11~183130~0~183130~6.11~401343~6.10~147~6.09~11~6.08~113~6.07~175~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309093940~0.56~10.09~6.11~6.11~6.11/183130/111892619~183130~11189~0.35~28.41~~6.11~6.11~0.00~323.80~411.82~1.66~6.11~5.00~4.97~401789~6.11~42.75~35.29~~~1.29~11189.26~0.00~0~ ~GP-A~-26.03~~0.85~6.84~2.76";"""
#s = """v_sh600370="1~三房巷~600370~3.83~3.48~3.62~349975~206189~143786~3.82~411~3.81~675~3.80~1328~3.79~305~3.78~1158~3.83~7802~0.00~0~0.00~0~0.00~0~0.00~0~~20200309093940~0.35~10.06~3.83~3.50~3.83/349975/131095133~349975~13110~4.39~56.09~~3.83~3.50~9.48~30.53~30.53~2.29~3.83~3.13~48.76~-3925~3.75~48.24~56.94~~~0.86~13109.51~0.00~0~ ~GP-A~25.57~~0.65~4.08~4.29";"""
text = """
v_sh601872="1~招商轮船~601872~6.11~5.55~6.11~192018~0~192018~6.11~393359~6.10~175~6.09~41~6.08~509~6.07~175~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094243~0.56~10.09~6.11~6.11~6.11/192018/117323187~192018~11732~0.36~28.41~~6.11~6.11~0.00~323.80~411.82~1.66~6.11~5.00~4.01~394259~6.11~42.75~35.29~~~1.29~11732.32~0.00~0~ ~GP-A~-26.03~~0.85~6.84~2.76";
v_sh600370="1~三房巷~600370~3.83~3.48~3.62~396867~239545~157322~3.81~1219~3.80~1924~3.79~364~3.78~631~3.77~874~3.83~1606~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~0.35~10.06~3.83~3.50~3.83/396867/149027215~396867~14903~4.98~56.09~~3.83~3.50~9.48~30.53~30.53~2.29~3.83~3.13~42.53~3406~3.76~48.24~56.94~~~0.86~14902.72~0.00~0~ ~GP-A~25.57~~0.65~4.08~4.29";
v_sh600550="1~保变电气~600550~6.55~6.08~6.25~811230~310623~500607~6.55~9~6.54~105~6.53~2~6.51~110~6.50~2224~6.56~1403~6.57~86~6.58~1706~6.59~25~6.60~1104~~20200309094242~0.47~7.73~6.69~6.25~6.55/811230/529081572~811230~52908~5.29~-17.48~~6.69~6.25~7.24~100.52~120.62~17.05~6.69~5.47~25.54~-1874~6.52~-126.67~-14.77~~~1.09~52908.16~0.00~0~ ~GP-A~112.66~~0.00~-97.53~-10.78";
v_sh600172="1~黄河旋风~600172~4.06~3.69~3.99~622192~317629~304562~4.06~175282~4.05~1873~4.04~172~4.03~1166~4.02~637~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~0.37~10.03~4.06~3.80~4.06/622192/247253272~622192~24725~5.24~-20.86~~4.06~3.80~7.05~48.18~58.55~1.31~4.06~3.32~14.07~179130~3.97~75.20~-24.64~~~1.50~24725.33~0.00~0~ ~GP-A~39.52~~0.00~-6.24~-2.66";
v_sh601696="1~中银证券~601696~16.90~15.36~16.90~25423~0~25423~16.90~1814929~16.89~3241~16.88~225~16.87~25~16.86~169~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~1.54~10.03~16.90~16.90~16.90/25423/42964549~25423~4296~0.91~57.86~~16.90~16.90~0.00~46.98~469.48~3.31~16.90~13.82~47.18~1818589~16.90~45.43~66.59~~~~4296.45~0.00~0~ ~GP-A~208.96~~0.00~6.39~1.68";
v_sh603059="1~倍加洁~603059~27.56~25.05~27.00~19358~9025~10333~27.56~15673~27.55~1~27.54~4~27.50~7~27.49~30~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~2.51~10.02~27.56~26.50~27.56/19358/52681290~19358~5268~7.74~26.33~~27.56~26.50~4.23~6.89~27.56~2.90~27.56~22.55~29.41~15715~27.21~23.65~29.19~~~1.18~5268.13~0.00~0~ ~GP-A~-2.27~~0.32~11.02~8.91";
v_sh600783="1~鲁信创投~600783~16.28~14.80~16.28~110265~4213~106052~16.28~76298~16.27~591~16.26~31~16.25~300~16.24~19~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094242~1.48~10.00~16.28~16.24~16.28/110265/179511549~110265~17951~1.48~308.30~~16.28~16.24~0.27~121.18~121.18~3.45~16.28~13.32~12.88~77239~16.28~131.19~64.83~~~1.75~17951.15~0.00~0~ ~GP-A~3.43~~0.61~1.12~0.66";
v_sh600896="1~览海投资~600896~4.95~4.50~4.90~158004~33537~124467~4.95~117413~4.94~353~4.93~937~4.92~179~4.91~297~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~0.45~10.00~4.95~4.79~4.95/158004/77942184~158004~7794~1.82~-24.56~~4.95~4.79~3.56~43.02~43.02~2.70~4.95~4.05~54.31~119179~4.93~-24.56~-24.56~~~1.17~7794.22~0.00~0~ ~GP-A~15.65~~0.00~-11.00~-7.84";
v_sh603719="1~良品铺子~603719~44.45~40.41~44.45~1312~0~1312~44.45~565940~44.44~250~44.43~18~44.42~20~44.41~123~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~4.04~10.00~44.45~44.45~44.45/1312/5829706~1312~583~0.32~46.67~~44.45~44.45~0.00~18.22~178.24~9.85~44.45~36.37~8.70~566351~44.45~42.52~74.72~~~~582.97~0.00~0~ ~GP-A~273.53~~0.00~27.48~11.65";
v_sh603948="1~建业股份~603948~33.04~30.04~33.04~3655~0~3655~33.04~57061~33.03~33~33.02~11~33.01~189~33.00~117~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~3.00~9.99~33.04~33.04~33.04/3655/12076781~3655~1208~0.91~37.09~~33.04~33.04~0.00~13.22~52.86~4.00~33.04~27.04~55.17~57411~33.04~37.09~37.09~~~~1207.68~0.00~0~ ~GP-A~131.86~~0.00~17.27~12.89";
v_sh600645="1~中源协和~600645~23.20~21.52~23.00~188408~88267~100140~23.11~21~23.10~66~23.08~4~23.06~30~23.05~2~23.20~342~23.21~4~23.22~45~23.23~94~23.25~190~~20200309094242~1.68~7.81~23.67~22.38~23.20/188408/439644665~188408~43964~4.91~-59.72~~23.67~22.38~5.99~89.04~108.57~3.24~23.67~19.37~20.91~-552~23.33~87.09~183.23~~~1.21~43964.47~0.00~0~ ~GP-A~37.03~~0.00~-5.43~-3.57";
v_sh603601="1~再升科技~603601~18.30~16.64~18.30~9168~0~9168~18.30~236545~18.29~325~18.28~156~18.27~60~18.26~87~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094240~1.66~9.98~18.30~18.30~18.30/9168/16778245~9168~1678~0.13~74.69~~18.30~18.30~0.00~128.62~128.62~9.44~18.30~14.98~0.23~237173~18.30~71.78~80.91~~~0.70~1677.82~0.00~0~ ~GP-A~139.22~~0.63~12.44~7.52";
v_sh603011="1~合锻智能~603011~7.40~6.73~7.40~79762~0~79762~7.40~100917~7.39~550~7.38~32~7.37~50~7.36~85~0.00~0~0.00~0~0.00~0~0.00~0~0.00~0~~20200309094242~0.67~9.96~7.40~7.40~7.40/79762/59024132~79762~5902~1.78~114.49~~7.40~7.40~0.00~33.22~33.53~2.03~7.40~6.06~5.57~101634~7.40~157.03~65.16~~~1.33~5902.41~0.00~0~ ~GP-A~47.12~~1.45~1.77~1.25";
v_sh600069="1~银鸽投资~600069~2.82~2.61~2.86~661230~273236~387994~2.82~1923~2.81~1875~2.80~4644~2.79~1346~2.78~1741~2.83~87~2.84~1126~2.85~3878~2.86~1294~2.87~27582~~20200309094243~0.21~8.05~2.87~2.72~2.82/661230/188406908~661230~18841~4.07~-15.97~~2.87~2.72~5.75~45.79~45.79~2.49~2.87~2.35~17.85~-22438~2.85~-18.71~-51.64~~~1.31~18840.69~0.00~0~ ~GP-A~5.62~~0.00~-15.61~-5.82";
v_sh600026="1~中远海能~600026~6.43~5.87~6.36~519451~222005~297445~6.41~736~6.40~839~6.39~973~6.38~1757~6.37~237~6.43~159~6.44~3980~6.45~13209~6.46~48884~0.00~0~~20200309094240~0.56~9.54~6.46~6.31~6.43/519451/333139117~519451~33314~1.90~27.04~~6.46~6.31~2.56~175.93~259.26~0.91~6.46~5.28~40.42~-61690~6.41~33.36~246.61~~~1.29~33313.91~0.00~0~ ~GP-A~0.78~~0.31~3.38~1.84";
v_sh600738="1~兰州民百~600738~5.36~5.07~5.37~200891~84130~116761~5.35~230~5.34~40~5.32~1063~5.31~348~5.30~1770~5.36~111~5.37~2~5.38~36~5.39~1~5.40~345~~20200309094243~0.29~5.72~5.58~5.16~5.36/200891/108936053~200891~10894~4.88~7.75~~5.58~5.16~8.28~22.06~41.46~2.61~5.58~4.56~34.39~2956~5.42~15.33~2.62~~~1.26~10893.61~0.00~0~ ~GP-A~8.50~~5.48~29.46~12.50";
v_sh603518="1~锦泓集团~603518~9.99~9.33~9.80~125959~65182~60777~9.99~124~9.98~95~9.97~164~9.96~457~9.95~736~10.00~459~10.02~2~10.03~46~10.04~310~10.05~21~~20200309094240~0.66~7.07~10.23~9.50~9.99/125959/123796324~125959~12380~5.07~15.18~~10.23~9.50~7.82~24.82~25.21~1.05~10.26~8.40~11.09~738~9.83~62.71~9.24~~~1.05~12379.63~0.00~0~ ~GP-A~41.30~~1.62~6.49~2.93";
v_sh600053="1~九鼎投资~600053~30.02~27.80~30.52~55805~26821~28984~30.00~3~29.97~15~29.90~1~29.88~56~29.87~3~30.02~51~30.05~29~30.10~49~30.13~7~30.14~198~~20200309094240~2.22~7.99~30.53~29.41~30.02/55805/167724170~55805~16772~1.29~25.51~~30.53~29.41~4.03~130.15~130.15~6.31~30.58~25.02~14.96~-256~30.06~43.25~45.79~~~1.65~16772.42~0.00~0~ ~GP-A~18.05~~2.47~24.73~12.26";
v_sh600688="1~上海石化~600688~4.94~4.50~4.50~611096~368910~242186~4.93~332~4.92~26~4.90~559~4.89~20~4.88~88~4.94~5691~4.95~40364~0.00~0~0.00~0~0.00~0~~20200309094243~0.44~9.78~4.95~4.36~4.94/611096/286027686~611096~28603~0.83~23.36~~4.95~4.36~13.11~362.04~534.70~1.82~4.95~4.05~21.15~-45030~4.68~23.98~10.13~~~0.65~28602.77~0.00~0~ ~GP-A~27.65~~5.06~7.80~5.89";
v_sh603301="1~振德医疗~603301~43.80~41.86~44.80~78231~34868~43363~43.66~53~43.64~1~43.60~9~43.59~1~43.58~3~43.80~12~43.88~597~43.96~9~43.99~3~44.00~83~~20200309094241~1.94~4.63~45.98~43.00~43.80/78231/351372856~78231~35137~14.35~43.78~~45.98~43.00~7.12~23.87~61.32~5.17~46.05~37.67~8.77~-637~44.91~48.35~47.10~~~0.47~35137.29~0.00~0~ ~GP-A~101.38~~0.57~11.81~6.21";
v_sh600312="1~平高电气~600312~8.63~8.09~8.89~723924~365377~358547~8.61~819~8.60~5049~8.59~116~8.58~238~8.57~121~8.63~550~8.64~1511~8.65~2761~8.66~748~8.67~403~~20200309094242~0.54~6.67~8.90~8.40~8.63/723924/633725529~723924~63373~5.34~29.13~~8.90~8.40~6.18~117.10~117.10~1.31~8.90~7.28~41.68~370~8.75~74.47~40.90~~~1.33~63372.55~0.00~0~ ~GP-A~33.59~~0.74~4.49~1.68";
v_sh603559="1~中通国脉~603559~26.73~24.92~25.40~160170~79159~81011~26.73~10~26.72~15~26.71~28~26.70~230~26.69~152~26.77~502~26.78~6~26.79~86~26.80~315~26.81~5~~20200309094242~1.81~7.26~27.41~25.10~26.73/160170/423791040~160170~42379~11.34~63.61~~27.41~25.10~9.27~37.77~38.31~4.30~27.41~22.43~12.15~-479~26.46~106.58~77.74~~~1.31~42379.10~0.00~0~ ~GP-A~50.25~~0.08~6.76~3.70";
v_sh600302="1~标准股份~600302~5.08~4.80~5.20~99633~53052~46581~5.05~4~5.03~20~5.00~63~4.99~400~4.98~107~5.07~24~5.08~392~5.09~261~5.10~464~5.11~3218~~20200309094240~0.28~5.83~5.20~4.82~5.08/99633/50798251~99633~5080~2.88~-164.47~~5.20~4.82~7.92~17.58~17.58~1.51~5.28~4.32~45.71~-3765~5.10~-18.18~61.95~~~1.14~5079.83~0.00~0~ ~GP-A~0.79~~0.00~-0.92~-0.66";
v_sh600252="1~中恒集团~600252~3.51~3.34~3.67~564559~232751~331808~3.51~2105~3.50~6001~3.49~1457~3.48~2020~3.47~300~3.52~2872~3.53~2281~3.54~1265~3.55~2852~3.56~4919~~20200309094242~0.17~5.09~3.67~3.49~3.51/564559/203506283~564559~20351~1.62~17.11~~3.67~3.49~5.39~121.98~121.98~1.95~3.67~3.01~28.71~-2306~3.60~15.85~19.89~~~1.15~20350.63~0.00~0~ ~GP-A~7.67~~1.71~11.41~9.23";
v_sh600798="1~宁波海运~600798~3.48~3.30~3.45~292314~124368~167946~3.47~1218~3.46~1895~3.45~2243~3.44~1223~3.43~360~3.48~342~3.49~2528~3.50~7521~3.51~1630~3.52~3825~~20200309094242~0.18~5.45~3.63~3.45~3.48/292314/104432993~292314~10443~2.84~17.04~~3.63~3.45~5.45~35.87~41.99~1.18~3.63~2.97~41.22~-8907~3.57~17.31~17.82~~~1.25~10443.30~0.00~0~ ~GP-A~-2.25~~1.72~6.93~5.67";
"""
bi = 0
ei = 0
i = 0
while ei!=-1:
    ei = text.find('\n',bi)
    ln = text[bi:ei]
    if len(ln)>16 and ln[:2]=='v_':
        a = ln.split('~')
        if len(a)==67:
            code = a[0][2:10].lower()
            ts = a[30] #20200309093940
            timestamp = datetime(int(ts[:4]),int(ts[4:6]),int(ts[6:8]),int(ts[8:10]),int(ts[10:12]),int(ts[12:]))
            vol = float(a[6])
            for i in range(10):
                c = float(a[2*i+9])
                if i==0:
                    open1 = c
                    high = c
                    low = c
                if c>0:
                    high = max(high,c)
                    low = min(low,c)
                    close1 = c
            print(code,timestamp,vol,open1,high,low,close1)
            i+=1
    bi = ei+1
#plane = np.zeros((len(companys),7),dtype=float)
#xueqiu.sinaRT(coms[:10],plane[:10,1:])
#print(plane)
#xueqiu.updateAllRT()
#status.downloadAllKFast(companys,5,48,progress)
# xueqiu.clearAllRT()
#status.updateRT(companys)
